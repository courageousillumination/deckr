<style type="text/css">
.zone {
    float: left;
    width: 80px;
    height: 100px;
    margin: 5px;
    padding: 15px;
    border: 1px dotted #ccc;
}

.zone#hand {
    width: 200px;
}

.zone.last {
    float: right;
}

.victory {
    float: right;
}

.vertical-fan {
    height: 350px;
}

.vertical-fan img {
    margin-bottom: -78px;
}

.horizontal-fan {
    width: 350px;
}

div.horizontal-fan{
    padding-left: 85px;
}

.horizontal-fan img {
    margin-left: -60px;
}

.horizontal-fan .facing-up img {
    margin-right: -60px;
}

.facing-top img{
    transform: rotate(180deg);
}

.facing-left img{
    transform: rotate(90deg);
}

.facing-right img{
    transform: rotate(270deg);
}

.center-field {
    height: 350px;
    width: 350px;
}

.stacked img {
    position: absolute
}

.row {
    clear: both;
    width: 100%;
    overflow: hidden;
}

.selected {
    border: solid;
    border-color: yellow;
}

textarea {
    overflow: scroll;
    resize: none;
}

</style>

<script type='text/javascript'>

function parseAction(data) {
    nickname = data[0];
    transitions = data[1];
    state = data[2];

    tricks = [];

    for(i = 0; i < transitions.length; i++) {
        transition = transitions[i];
        event_box = document.getElementById("eventbox");
        console.log(state.cards)

        if(transition[0] == "add") {
            // IDs start at 0 in dictionary
            zone_id = transition[2] - 1;
            card_id = transition[1] - 1;

            switch(state.cards[card_id].number) {
                case 11: number = "jack"; break;
                case 12: number = "queen"; break;
                case 13: number = "king"; break;
                case 14: number = "ace"; break;
                default: number = state.cards[card_id].number.toString();
            }

            card_name = "the " + number + " of " + state.cards[card_id].suit;

            console.log(state.zones[zone_id].name)
            
            if(state.zones[zone_id].name == "play_zone") {
                event_box.innerHTML += nickname + " played " + card_name + ".&#13;";
            }
            if(state.zones[zone_id].name == "discard") {
                tricks.push(card_name);
            }
        }
    }

    if((tricks.length) > 0) {
        event_box.innerHTML += nickname + " won ";
        for(i = 0; i < tricks.length; i++) {
            card = tricks[i];
            if(i < tricks.length - 1) {
                if(i < tricks.length - 2)
                    card += ", ";
                else
                    card += " and ";
            }
            event_box.innerHTML += card;
        }
        event_box.innerHTML += ".&#13;";
    }

    event_box.scrollTop = event_box.scrollHeight;
}

$(document).ready(function() {

    // zone click function
    /*$(".zone").click(function() {
        if ($('.selected').length != 0 && $(this).has($('.selected')).length == 0) {
            console.log("Request move " + $('.selected').attr('id'));
            requestMoveCard($('.selected').attr('id'), $(this).attr('id'));
        }
    });*/

    $("#play_zone").click(function() {
        socket.emit('action', {'action_name': 'take_trick'});
    });

    event_box = document.getElementById("eventbox");
    event_box.scrollTop = event_box.scrollHeight;
});

function convert_game_id_to_player_order_id(game_id) {
  my_ordered_game_ids = [my_game_id].concat(_.filter(player_ids, function (x) { return x > my_game_id; })).concat(_.filter(player_ids, function (x) { return x < my_game_id; }));
  return my_ordered_game_ids.indexOf(game_id) + 1;
}

socket.on('state', function (data) {

    console.log(data);

    for (i = 0; i < data.cards.length; i++) {
        d = data.cards[i];
        d.class = "card";
        d.id = "card" + d.game_id;
        addCard(d, "staging_area");
    }

    // Add all cards to the proper zones
    for (i = 0; i < data.zones.length; i++) {

        zone = data.zones[i];
        // Fix the zone names
        if (zone.owner == null) {
            $("#" + zone.name).attr('id', "zone" + zone.game_id);
        } else {
            // Find the zone with the name + the player order id
            z = $("#" + zone.name + convert_game_id_to_player_order_id(zone.owner));
            z.attr('id', 'zone' + zone.game_id);
            //z.append('owned by' + player_mapping[zone.owner]);
        }

        for (j = 0; j < zone.cards.length; j++) {
            moveCard("card" + zone.cards[j], "zone" + zone.game_id, 0);
        }
    }

    $(".deck").click(function() {
        data = Object();
        data.action_name = 'draw';
        socket.emit('action', data);
        $('.selected').removeClass('selected');
    });

    // Make sure we register all callbacks
    $(".card").click(function() {
        socket.emit('action', {'action_name': 'play_card',
                               'card': $(this).attr('id').substring(4)});
    });
});
/*
function zoneOnClick() {
    if ($('.selected').length != 0 && $(this).has($('.selected')).length == 0) {
        console.log("Request move " + $('.selected').attr('id'));
        requestMoveCard($('.selected').attr('id'), $(this).attr('id'));
    }
}
function deckOnClick() {
    data = Object();
    data.action_name = 'draw';
    socket.emit('action', data);
    $('.selected').removeClass('selected');
}
function cardOnClick() {
    if($(this).attr('face_up') == 'false') {
        console.log('Clicked on face down card.');
        return
    }
    if ($('.selected').length == 0) {
        $(this).addClass('selected');
    } else if ($(this).hasClass('selected')) {
        $(this).removeClass('selected');
    } else {
        parent = $(this).parent();
        parent.click.apply(parent);
    }
    console.log($('.selected').attr('id') + " is selected.");
}
socket.on('state', function (data) {
    setupInitialState(data);
    setupClickEvents({
        ".deck": deckOnClick,
        ".card": cardOnClick,
        ".zone": zoneOnClick
    });
}); */
</script>

<div class="layout">
    <button onclick="socket.emit('start');">Start</button><br />
    <textarea readonly rows="5" cols="50" id="eventbox">Welcome to the game!&#13;></textarea>
    <div class="table" id="region0">
        <div class="row" id="region1">
            <div class="stacked zone" id="discard3"></div>
            <div class="horizontal-fan facing-up zone" id="hand3"></div>
            <div class="stacked zone" id="discard4"></div>
        </div>

        <div class="row" id="region2">
            <div class="vertical-fan facing-left zone" id="hand2"></div>

            <div class="center-field zone" id="play_zone"></div>

            <div class="vertical-fan facing-right zone" id="hand4"></div>
        </div>
        
        <div class="row" id="region3">
            <div class="stacked zone" id="discard2"></div>
            <div class="horizontal-fan zone" id="hand1"></div>
            <div class="stacked zone" id="discard1"></div>
        </div>
        <div class="row" id="region4">
            <div class="zone" id="side_zone"></div>
        </div>
    </div>
</div>
